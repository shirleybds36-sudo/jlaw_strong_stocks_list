name: Daily US Watchlist + JLaw Scanner

on:
  schedule:
    - cron: "0 15 * * *"      # 15:00 UTC (08:00 PT in DST)
  workflow_dispatch: {}

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: America/Los_Angeles
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # sanity check
          python - <<'PY'
          import importlib
          for m in ["pandas","numpy","yfinance","lxml","requests"]:
              importlib.import_module(m)
          print("Deps OK")
          PY

      - name: Generate US initial watchlist (with retry)
        run: |
          set -e
          for i in 1 2 3; do
            python scripts/generate_us_watchlist.py && break || {
              echo "Retry $i after 10s..."; sleep 10;
            }
          done
          test -s data/watchlist.txt && head -n 5 data/watchlist.txt || (echo "watchlist empty"; exit 1)

      - name: Run JLaw scanner with generated watchlist
        run: |
          mkdir -p scan_outputs
          python jlaw_strong_stock_scanner.py \
            -w data/watchlist.txt \
            -o scan_outputs \
            -b SPY \
            --rs_pctile_min 85 \
            --near_52w_max_gap 0.20 \
            --pivot_tight_max_range 0.08 \
            --vol_contraction_max 0.001 \
            --vol_dryup_max_ratio 0.90 \
            --vol_breakout_mult 1.5 \
            --near_trigger_pct 0.02 \
            --breakout_confirm_on high


      - name: Upload artifacts (CSV)
        uses: actions/upload-artifact@v4
        with:
          name: scan-csv
          path: scan_outputs/*.csv
          if-no-files-found: warn
          retention-days: 10

      - name: Commit CSV back to repo
        if: ${{ success() && github.event_name != 'pull_request' }}
        run: |
          mkdir -p daily_csv
          cp -f scan_outputs/*.csv daily_csv/ 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add daily_csv/*.csv data/watchlist.txt || true
          if ! git diff --cached --quiet; then
            git commit -m "Daily scan + watchlist ($(date +'%Y-%m-%d %H:%M %Z'))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi

      - name: Email results
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true           # keep soft while testing; remove later
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "JLaw 美股候选清单 $(date +'%Y-%m-%d')"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          secure: true
          attachments: |
            scan_outputs/*.csv
          body: |
            今日美股初选清单已生成并用于 JLaw 扫描。
            生成时间：$(date +'%Y-%m-%d %H:%M %Z')
