name: US Watchlist + JLaw Scanner

on:
  schedule:
    - cron: "0 15 */2 * *"     # every 2 days at 15:00 UTC
  workflow_dispatch: {}


permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: America/Los_Angeles
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # sanity check
          python - <<'PY'
          import importlib
          for m in ["pandas","numpy","yfinance","lxml","requests"]:
              importlib.import_module(m)
          print("Deps OK")
          PY

      - name: Generate US initial watchlist (with retry)
        run: |
          set -e
          for i in 1 2 3; do
            python scripts/generate_us_watchlist.py && break || {
              echo "Retry $i after 10s..."; sleep 10;
            }
          done
          test -s data/watchlist.txt && head -n 5 data/watchlist.txt || (echo "watchlist empty"; exit 1)

      - name: Run JLaw scanner with generated watchlist
        run: |
          mkdir -p scan_outputs
          python jlaw_strong_stock_scanner.py \
            -w data/watchlist.txt \
            -o scan_outputs \
            -b SPY \
            --rs_pctile_min 75 \
            --near_52w_max_gap 0.30 \
            --pivot_tight_max_range 0.12 \
            --vol_contraction_max 0.015 \
            --vol_dryup_max_ratio 1.10 \
            --vol_breakout_mult 1.3 \
            --near_trigger_pct 0.03 \
            --breakout_confirm_on high \
            --entry_extension_pct 0.02 \
            --watchlist_out data/jlaw_watchlist.txt \
            --watchlist_source candidates \
            --watchlist_max 200 \
            --watchlist_signals WATCH_NEAR_TRIGGER,BREAKOUT_CONFIRMED


      - name: Upload artifacts (CSV)
        uses: actions/upload-artifact@v4
        with:
          name: scan-csv
          path: scan_outputs/*.csv
          if-no-files-found: warn
          retention-days: 10


      - name: Commit CSV back to repo (keep only last 7 days)
        if: ${{ success() && github.event_name != 'pull_request' }}
        run: |
          set -e
          mkdir -p daily_csv

          # 1) copy today's outputs
          cp -f scan_outputs/*.csv daily_csv/ 2>/dev/null || true

          # 2) prune old CSVs in repo folder (keep last 7 days)
          CUTOFF=$(date -d "7 days ago" +%F)
          echo "Pruning daily_csv files older than $CUTOFF ..."

          shopt -s nullglob
          for f in daily_csv/*.csv; do
            # extract YYYY-MM-DD from filename if present
            d=$(echo "$f" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -n 1 || true)
            if [ -n "$d" ] && [[ "$d" < "$CUTOFF" ]]; then
              echo "Delete: $f (date=$d)"
              rm -f "$f"
            fi
          done
          shopt -u nullglob

          # (Optional) also prune old reports if you store them in other folders
          # same logic could be repeated for reports/*.csv etc.

          # 3) commit changes (including deletions)
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add daily_csv/*.csv data/watchlist.txt data/jlaw_watchlist.txt || true
          git add -u  # IMPORTANT: stage deletions

          if ! git diff --cached --quiet; then
            git commit -m "Daily scan + watchlist ($(date +'%Y-%m-%d %H:%M %Z'))"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi

      - name: Email results
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true           # keep soft while testing; remove later
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "JLaw 美股候选清单 $(date +'%Y-%m-%d')"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          secure: true
          attachments: |
            scan_outputs/*.csv
          body: |
            今日美股初选清单已生成并用于 JLaw 扫描。
            生成时间：$(date +'%Y-%m-%d %H:%M %Z')
